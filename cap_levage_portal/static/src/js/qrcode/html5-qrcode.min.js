"use strict";function _typeof(a){"@babel/helpers - typeof";return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a},_typeof(a)}function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function _defineProperties(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}function _createClass(a,b,c){return b&&_defineProperties(a.prototype,b),c&&_defineProperties(a,c),a}function _defineProperty(a,b,c){return b in a?Object.defineProperty(a,b,{value:c,enumerable:!0,configurable:!0,writable:!0}):a[b]=c,a}var Html5Qrcode=function(){function a(b,c){if(_classCallCheck(this,a),!getLazarSoftScanner)throw"Use html5qrcode.min.js without edit, getLazarSoftScannernot found.";if(this.qrcode=getLazarSoftScanner(),!this.qrcode)throw"qrcode is not defined, use the minified/html5-qrcode.min.js for proper support";this._elementId=b,this._foreverScanTimeout=null,this._localMediaStream=null,this._shouldScan=!0,this._url=window.URL||window.webkitURL||window.mozURL||window.msURL,this._userMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,this._isScanning=!1,a.VERBOSE=!0===c}return _createClass(a,[{key:"start",value:function(b,c,d,e){var f=this;if(!b)throw"cameraIdOrConfig is required";if(!d||"function"!=typeof d)throw"qrCodeSuccessCallback is required and should be a function.";e||(e=console.log),this._clearElement();var g=this,h=c?c:{};h.fps=h.fps?h.fps:a.SCAN_DEFAULT_FPS;var i=!1;h.videoConstraints&&(this._isMediaStreamConstraintsValid(h.videoConstraints)?i=!0:a._logError("'videoConstraints' is not valid 'MediaStreamConstraints, it will be ignored.'",!0));var j=i,k=void 0!==h.qrbox,l=document.getElementById(this._elementId),m=l.clientWidth?l.clientWidth:a.DEFAULT_WIDTH;if(l.style.position="relative",this._shouldScan=!0,this._element=l,this.qrcode.doNegatif=!!h.doNegatif&&h.doNegatif,this.qrcode.callback=d,k){var n=h.qrbox;if(n<a.MIN_QR_BOX_SIZE)throw"minimum size of 'config.qrbox' is"+" ".concat(a.MIN_QR_BOX_SIZE,"px.");if(n>m)throw"'config.qrbox' should not be greater than the width of the HTML element."}var o=function(a,b){var c=h.qrbox;c>b&&console.warn("[Html5Qrcode] config.qrboxsize is greater than video height. Shading will be ignored");var d=k&&c<=b,e=d?f._getShadedRegionBounds(a,b,c):{x:0,y:0,width:a,height:b},i=f._createCanvasElement(e.width,e.height),j=i.getContext("2d");j.canvas.width=e.width,j.canvas.height=e.height,l.append(i),d&&f._possiblyInsertShadingElement(l,a,b,c),g._qrRegion=e,g._context=j,g._canvasElement=i},p=function(){try{return g.qrcode.doNegatif=!1,g.qrcode.decode(),f._possiblyUpdateShaders(!0),!0}catch(a){return f._possiblyUpdateShaders(!1),e("QR code parse error, error = ".concat(a)),!1}},q=function(){try{return g.qrcode.doNegatif=!0,g.qrcode.decode(),f._possiblyUpdateShaders(!0),!0}catch(a){return f._possiblyUpdateShaders(!1),e("QR code parse error, error = ".concat(a)),!1}},r=function b(){if(g._shouldScan){if(g._localMediaStream){var c=g._videoElement,d=c.videoWidth/c.clientWidth,e=c.videoHeight/c.clientHeight,i=g._qrRegion.width*d,j=g._qrRegion.height*e,k=g._qrRegion.x*d,l=g._qrRegion.y*e;g._context.drawImage(g._videoElement,k,l,i,j,0,0,g._qrRegion.width,g._qrRegion.height);var m=p(),n=!1;if(m||(n=q()),!m&&!n&&!0!==h.disableFlip){f._context.translate(f._context.canvas.width,0),f._context.scale(-1,1);var o=p();o||q()}}g._foreverScanTimeout=setTimeout(b,a._getTimeoutFps(h.fps))}},s=function(a){return new Promise(function(b,c){var d=function(){var d=f._createVideoElement(m);g._element.append(d),d.onabort=c,d.onerror=c,d.onplaying=function(){var a=d.clientWidth,c=d.clientHeight;o(a,c),r(),b()},d.srcObject=a,d.play(),g._videoElement=d};if(g._localMediaStream=a,j||!h.aspectRatio)d();else{var e={aspectRatio:h.aspectRatio},i=a.getVideoTracks()[0];i.applyConstraints(e).then(function(){return d()})["catch"](function(a){console.log("[Warning] [Html5Qrcode] Constriants could not be satisfied, ignoring constraints",a),d()})}})};return new Promise(function(a,c){if(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia){var d=j?h.videoConstraints:g._createVideoConstraints(b);navigator.mediaDevices.getUserMedia({audio:!1,video:d}).then(function(b){s(b).then(function(){g._isScanning=!0,a()})["catch"](c)})["catch"](function(a){c("Error getting userMedia, error = ".concat(a))})}else if(navigator.getUserMedia){if("string"!=typeof b)throw"The device doesn't support navigator.mediaDevices, only supported cameraIdOrConfig in this case is deviceId parameter (string).";navigator.getUserMedia({video:{optional:[{sourceId:b}]}},function(b){s(b).then(function(){g._isScanning=!0,a()})["catch"](c)},function(a){c("Error getting userMedia, error = ".concat(a))})}else c("Web camera streaming not supported by the browser.")})}},{key:"stop",value:function(){this._shouldScan=!1,clearTimeout(this._foreverScanTimeout);var b=this;return new Promise(function(c){b.qrcode.callback=null;var d=b._localMediaStream.getVideoTracks().length,e=0,f=function(){for(;b._element.getElementsByClassName(a.SHADED_REGION_CLASSNAME).length;){var c=b._element.getElementsByClassName(a.SHADED_REGION_CLASSNAME)[0];b._element.removeChild(c)}},g=function(){b._localMediaStream=null,b._element.removeChild(b._videoElement),b._element.removeChild(b._canvasElement),f(),b._isScanning=!1,b._qrRegion&&(b._qrRegion=null),b._context&&(b._context=null),c(!0)};b._localMediaStream.getVideoTracks().forEach(function(a){a.stop(),++e,e>=d&&g()})})}},{key:"scanFile",value:function(b,c){var d=this;if(!b||!(b instanceof File))throw"imageFile argument is mandatory and should be instance of File. Use 'event.target.files[0]'";if(c=void 0===c||c,d._isScanning)throw"Close ongoing scan before scanning a file.";var e=function b(c,d,e,f){if(c<=e&&d<=f){var g=(e-c)/2,h=(f-d)/2;return{x:g,y:h,width:c,height:d}}var i=c,j=d;return c>e&&(d=e/c*d,c=e),d>f&&(c=f/d*c,d=f),a._log("Image downsampled from "+"".concat(i,"X").concat(j)+" to ".concat(c,"X").concat(d,".")),b(c,d,e,f)};return new Promise(function(f,g){d._possiblyCloseLastScanImageFile(),d._clearElement(),d._lastScanImageFile=b;var h=new Image;h.onload=function(){var b=Math.max,i=h.width,j=h.height,k=document.getElementById(d._elementId),l=k.clientWidth?k.clientWidth:a.DEFAULT_WIDTH,m=b(k.clientHeight?k.clientHeight:j,a.FILE_SCAN_MIN_HEIGHT),n=e(i,j,l,m);if(c){var o=d._createCanvasElement(l,m,"qr-canvas-visible");o.style.display="inline-block",k.appendChild(o);var p=o.getContext("2d");p.canvas.width=l,p.canvas.height=m,p.drawImage(h,0,0,i,j,n.x,n.y,n.width,n.height)}var q=d._createCanvasElement(n.width,n.height);k.appendChild(q);var r=q.getContext("2d");r.canvas.width=n.width,r.canvas.height=n.height,r.drawImage(h,0,0,i,j,0,0,n.width,n.height);try{f(d.qrcode.decode())}catch(a){g("QR code parse error, error = ".concat(a))}},h.onerror=g,h.onabort=g,h.onstalled=g,h.onsuspend=g,h.src=URL.createObjectURL(b)})}},{key:"clear",value:function(){this._clearElement()}},{key:"getRunningTrackCapabilities",value:function(){if(null==this._localMediaStream)throw"Scanning is not in running state, call this API only when QR code scanning using camera is in running state.";if(0===this._localMediaStream.getVideoTracks().length)throw"No video tracks found";var a=this._localMediaStream.getVideoTracks()[0];return a.getCapabilities()}},{key:"applyVideoConstraints",value:function(a){var b=this;if(!a)throw"videoConstaints is required argument.";else if(!this._isMediaStreamConstraintsValid(a))throw"invalid videoConstaints passed, check logs for more details";if(null==this._localMediaStream)throw"Scanning is not in running state, call this API only when QR code scanning using camera is in running state.";if(0===this._localMediaStream.getVideoTracks().length)throw"No video tracks found";return new Promise(function(c,d){if("aspectRatio"in a)return void d("Chaning 'aspectRatio' in run-time is not yet supported.");var e=b._localMediaStream.getVideoTracks()[0];e.applyConstraints(a).then(function(a){c(a)})["catch"](function(a){d(a)})})}},{key:"_clearElement",value:function(){if(this._isScanning)throw"Cannot clear while scan is ongoing, close it first.";var a=document.getElementById(this._elementId);a.innerHTML=""}},{key:"_createCanvasElement",value:function(a,b,c){var d=document.createElement("canvas");return d.style.width="".concat(a,"px"),d.style.height="".concat(b,"px"),d.style.display="none",d.id=void 0===c?"qr-canvas":c,d}},{key:"_createVideoElement",value:function(a){var b=document.createElement("video");return b.style.width="".concat(a,"px"),b.muted=!0,b.playsInline=!0,b}},{key:"_getShadedRegionBounds",value:function(a,b,c){if(c>a||c>b)throw"'config.qrbox' should not be greater than the width and height of the HTML element.";return{x:(a-c)/2,y:(b-c)/2,width:c,height:c}}},{key:"_possiblyInsertShadingElement",value:function(b,c,d,e){if(!(1>c-e||1>d-e)){var f=document.createElement("div");if(f.style.position="absolute",f.style.borderLeft="".concat((c-e)/2,"px solid #0000007a"),f.style.borderRight="".concat((c-e)/2,"px solid #0000007a"),f.style.borderTop="".concat((d-e)/2,"px solid #0000007a"),f.style.borderBottom="".concat((d-e)/2,"px solid #0000007a"),f.style.boxSizing="border-box",f.style.top="0px",f.style.bottom="0px",f.style.left="0px",f.style.right="0px",f.id="".concat(a.SHADED_REGION_CLASSNAME),11>c-e||11>d-e)this.hasBorderShaders=!1;else{this._insertShaderBorders(f,40,5,-5,0,!0),this._insertShaderBorders(f,40,5,-5,0,!1),this._insertShaderBorders(f,40,5,e+5,0,!0),this._insertShaderBorders(f,40,5,e+5,0,!1),this._insertShaderBorders(f,5,45,-5,-5,!0),this._insertShaderBorders(f,5,45,e+5-40,-5,!0),this._insertShaderBorders(f,5,45,-5,-5,!1),this._insertShaderBorders(f,5,45,e+5-40,-5,!1),this.hasBorderShaders=!0}b.append(f)}}},{key:"_insertShaderBorders",value:function(b,c,d,e,f,g){var h=document.createElement("div");h.style.position="absolute",h.style.backgroundColor=a.BORDER_SHADER_DEFAULT_COLOR,h.style.width="".concat(c,"px"),h.style.height="".concat(d,"px"),h.style.top="".concat(e,"px"),g?h.style.left="".concat(f,"px"):h.style.right="".concat(f,"px"),this.borderShaders||(this.borderShaders=[]),this.borderShaders.push(h),b.appendChild(h)}},{key:"_possiblyUpdateShaders",value:function(b){this.qrMatch===b||(this.hasBorderShaders&&this.borderShaders&&this.borderShaders.length&&this.borderShaders.forEach(function(c){c.style.backgroundColor=b?a.BORDER_SHADER_MATCH_COLOR:a.BORDER_SHADER_DEFAULT_COLOR}),this.qrMatch=b)}},{key:"_possiblyCloseLastScanImageFile",value:function(){this._lastScanImageFile&&(URL.revokeObjectURL(this._lastScanImageFile),this._lastScanImageFile=null)}},{key:"_createVideoConstraints",value:function(a){if("string"==typeof a)return{deviceId:{exact:a}};if("object"===_typeof(a)){var b={user:!0,environment:!0},c=function(a){if(a in b)return!0;throw"config has invalid 'facingMode' value = "+"'".concat(a,"'")},d=Object.keys(a);if(1!==d.length)throw"'cameraIdOrConfig' object should have exactly 1 key,"+" if passed as an object, found ".concat(d.length," keys");var e=Object.keys(a)[0];if("facingMode"!==e&&"deviceId"!==e)throw"Only '".concat("facingMode","' and '").concat("deviceId","' ")+" are supported for 'cameraIdOrConfig'";if("facingMode"===e){var f=a[e];if("string"==typeof f){if(c(f))return{facingMode:f};}else if("object"!==_typeof(f)){var g=_typeof(f);throw"Invalid type of 'facingMode' = ".concat(g)}else if(!("exact"in f))throw"'facingMode' should be string or object with"+" ".concat("exact"," as key.");else if(c(f.exact))return{facingMode:{exact:f.exact}}}else{var h=a[e];if("string"==typeof h)return{deviceId:h};if("object"===_typeof(h)){if("exact"in h)return{deviceId:{exact:h.exact}};throw"'deviceId' should be string or object with"+" ".concat("exact"," as key.")}else{var i=_typeof(h);throw"Invalid type of 'deviceId' = ".concat(i)}}}else{var j=_typeof(a);throw"Invalid type of 'cameraIdOrConfig' = ".concat(j)}}},{key:"_isMediaStreamConstraintsValid",value:function(b){if(!b)return a._logError("Empty videoConstraints",!0),!1;if("object"!==_typeof(b)){var c=_typeof(b);return a._logError("videoConstraints should be of type object, the "+"object passed is of type ".concat(c,"."),!0),!1}for(var d,e=["autoGainControl","channelCount","echoCancellation","latency","noiseSuppression","sampleRate","sampleSize","volume"],f=new Set(e),g=Object.keys(b),h=0;h<g.length;h++)if(d=g[h],f.has(d))return a._logError("".concat(d," is not supported videoConstaints."),!0),!1;return!0}}],[{key:"getCameras",value:function(){var a=this;return new Promise(function(b,c){if(navigator.mediaDevices&&navigator.mediaDevices.enumerateDevices&&navigator.mediaDevices.getUserMedia)a._log("navigator.mediaDevices used"),navigator.mediaDevices.getUserMedia({audio:!1,video:!0}).then(function(d){d.oninactive=function(){return a._log("All streams closed")};var e=function(a){for(var b,c=a.getVideoTracks(),d=0;d<c.length;d++)b=c[d],b.enabled=!1,b.stop(),a.removeTrack(b)};navigator.mediaDevices.enumerateDevices().then(function(c){for(var f,g=[],h=0;h<c.length;h++)f=c[h],"videoinput"==f.kind&&g.push({id:f.deviceId,label:f.label});a._log("".concat(g.length," results found")),e(d),b(g)})["catch"](function(a){c("".concat(a.name," : ").concat(a.message))})})["catch"](function(a){c("".concat(a.name," : ").concat(a.message))});else if(MediaStreamTrack&&MediaStreamTrack.getSources){a._log("MediaStreamTrack.getSources used");var d=function(c){for(var d,e=[],f=0;f!==c.length;++f)d=c[f],"video"===d.kind&&e.push({id:d.id,label:d.label});a._log("".concat(e.length," results found")),b(e)};MediaStreamTrack.getSources(d)}else a._log("unable to query supported devices."),c("unable to query supported devices.")})}},{key:"_getTimeoutFps",value:function(a){return 1e3/a}},{key:"_log",value:function(b){a.VERBOSE&&console.log(b)}},{key:"_logError",value:function(b,c){(a.VERBOSE||!0===c)&&console.error(b)}}]),a}();_defineProperty(Html5Qrcode,"DEFAULT_WIDTH",300),_defineProperty(Html5Qrcode,"DEFAULT_WIDTH_OFFSET",2),_defineProperty(Html5Qrcode,"FILE_SCAN_MIN_HEIGHT",300),_defineProperty(Html5Qrcode,"SCAN_DEFAULT_FPS",2),_defineProperty(Html5Qrcode,"MIN_QR_BOX_SIZE",50),_defineProperty(Html5Qrcode,"SHADED_LEFT",1),_defineProperty(Html5Qrcode,"SHADED_RIGHT",2),_defineProperty(Html5Qrcode,"SHADED_TOP",3),_defineProperty(Html5Qrcode,"SHADED_BOTTOM",4),_defineProperty(Html5Qrcode,"SHADED_REGION_CLASSNAME","qr-shaded-region"),_defineProperty(Html5Qrcode,"VERBOSE",!1),_defineProperty(Html5Qrcode,"BORDER_SHADER_DEFAULT_COLOR","#ffffff"),_defineProperty(Html5Qrcode,"BORDER_SHADER_MATCH_COLOR","rgb(90, 193, 56)");